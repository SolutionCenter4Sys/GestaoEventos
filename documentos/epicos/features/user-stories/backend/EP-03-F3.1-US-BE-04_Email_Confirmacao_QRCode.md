# User Story ‚Äì Backend | Envio de E-mail de Confirma√ß√£o com QR Code

**√âpico:** EP-03 ‚Äì Sistema de Inscri√ß√µes e Participantes  
**Feature:** EP-03-F3.1 ‚Äì Formul√°rio de Inscri√ß√£o P√∫blico  
**Produto:** Plataforma de Gest√£o de Eventos | **Vers√£o:** 1.01 | **Data:** 10/02/2026

---

## 1. Identifica√ß√£o

| Campo | Conte√∫do |
|-------|----------|
| **ID da US** | EP-03-F3.1-US-BE-04 |
| **T√≠tulo** | Envio de E-mail de Confirma√ß√£o com QR Code |
| **Relacionada a** | EP-03-F3.1-US-BE-01 (Endpoint Inscri√ß√£o), EP-06-F6.2 (Gatilhos) |
| **Status** | Proposta |

---

## 2. Formato Como / Quero / Para que

**Como** sistema backend  
**Quero** disparar e-mail de confirma√ß√£o automaticamente ap√≥s inscri√ß√£o com todos os detalhes do evento + QR Code embutido  
**Para que** participante receba confirma√ß√£o imediata e possa fazer check-in no evento

---

## 3. Descri√ß√£o

Sistema de e-mail de confirma√ß√£o integrado com gatilhos:

**Conte√∫do do E-mail:**
- Confirma√ß√£o de inscri√ß√£o
- Nome do evento, data, hora, local
- QR Code embutido (imagem inline)
- Link para √°rea do participante
- Senha (se conta nova criada)
- Informa√ß√µes adicionais (estacionamento, dress code, etc.)

**Integra√ß√£o:** Via EP-06-F6.2 (Motor de Gatilhos)  
**Template:** `inscricao-confirmada.html`

---

## 4. Crit√©rios de Aceite

- [ ] E-mail enviado em at√© 1 minuto ap√≥s inscri√ß√£o
- [ ] Template HTML responsivo
- [ ] QR Code embutido como imagem inline (base64 ou CID)
- [ ] Vari√°veis substitu√≠das: nome, evento, data, hora, local, linkParticipante
- [ ] Se conta nova: inclui senha no e-mail
- [ ] E-mail rastre√°vel (tracking de abertura opcional)
- [ ] Fallback para plaintext

---

## 5. Implementa√ß√£o

### Evento Emitido (p√≥s-inscri√ß√£o)
```typescript
this.eventEmitter.emit('inscricao.confirmada', {
  inscricao: {
    id: 'uuid-inscricao',
    qrCode: 'uuid-qrcode',
    criadoEm: new Date()
  },
  usuario: {
    nome: 'Jo√£o Silva',
    email: 'joao@exemplo.com'
  },
  evento: {
    nome: 'Workshop de Cardiologia',
    dataInicio: new Date('2026-03-15T14:00:00Z'),
    local: 'Hospital Universit√°rio - Sala 201'
  },
  contaCriada: true,
  senha: 'Abc123!@#xyz'
});
```

### Listener (Gatilho)
```typescript
@OnEvent('inscricao.confirmada')
async handleInscricaoConfirmada(payload: InscricaoConfirmadaEvent): Promise<void> {
  const gatilho = await this.gatilhosConfig.findByNome('inscricao_confirmada');
  if (!gatilho || !gatilho.ativo) return;
  
  const template = await this.templateService.findById(gatilho.templateId);
  
  // Gerar QR Code como imagem base64
  const qrCodeDataUrl = await QRCode.toDataURL(payload.inscricao.qrCode, {
    width: 300,
    margin: 2,
    color: { dark: '#000000', light: '#FFFFFF' }
  });
  
  // Substituir vari√°veis
  const variaveis = {
    nomeParticipante: payload.usuario.nome,
    nomeEvento: payload.evento.nome,
    dataEvento: format(payload.evento.dataInicio, 'dd/MM/yyyy'),
    horaEvento: format(payload.evento.dataInicio, 'HH:mm'),
    localEvento: payload.evento.local,
    qrCodeImage: qrCodeDataUrl,
    linkParticipante: `${process.env.FRONTEND_URL}/participante/area`,
    senha: payload.contaCriada ? payload.senha : null,
    contaNova: payload.contaCriada
  };
  
  const assunto = this.substituirVariaveis(template.assunto, variaveis);
  const corpo = this.substituirVariaveis(template.corpo, variaveis);
  
  // Adicionar √† fila de envio
  await this.emailQueue.add({
    destinatario: payload.usuario.email,
    assunto,
    corpo,
    prioridade: 1, // Alta (confirma√ß√£o √© cr√≠tica)
    gatilhoId: gatilho.id,
    metadados: {
      inscricaoId: payload.inscricao.id,
      eventoId: payload.evento.id
    }
  });
}
```

### Template HTML (inscricao-confirmada.html)
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Confirma√ß√£o de Inscri√ß√£o</title>
</head>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <div style="background: #4CAF50; color: white; padding: 20px; text-align: center;">
    <h1>‚úÖ Inscri√ß√£o Confirmada!</h1>
  </div>
  
  <div style="padding: 20px;">
    <p>Ol√° <strong>{{nomeParticipante}}</strong>,</p>
    
    <p>Sua inscri√ß√£o no evento <strong>{{nomeEvento}}</strong> foi confirmada com sucesso!</p>
    
    <div style="background: #f5f5f5; padding: 15px; border-left: 4px solid #4CAF50; margin: 20px 0;">
      <h3 style="margin-top: 0;">Detalhes do Evento:</h3>
      <p><strong>üìÖ Data:</strong> {{dataEvento}}</p>
      <p><strong>üïí Hor√°rio:</strong> {{horaEvento}}</p>
      <p><strong>üìç Local:</strong> {{localEvento}}</p>
    </div>
    
    <div style="text-align: center; margin: 30px 0;">
      <h3>QR Code de Check-in:</h3>
      <img src="{{qrCodeImage}}" alt="QR Code" style="width: 200px; height: 200px;">
      <p style="font-size: 12px; color: #666;">Apresente este QR Code na recep√ß√£o do evento</p>
    </div>
    
    {{#if contaNova}}
    <div style="background: #FFF3CD; padding: 15px; border-left: 4px solid #FFC107; margin: 20px 0;">
      <h3 style="margin-top: 0;">üîê Sua Conta foi Criada</h3>
      <p>E-mail: <strong>{{email}}</strong></p>
      <p>Senha: <strong>{{senha}}</strong></p>
      <p style="font-size: 12px;">Recomendamos alterar sua senha no primeiro acesso.</p>
    </div>
    {{/if}}
    
    <div style="text-align: center; margin: 30px 0;">
      <a href="{{linkParticipante}}" style="background: #2196F3; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
        Acessar √Årea do Participante
      </a>
    </div>
    
    <p style="color: #666; font-size: 12px; margin-top: 30px;">
      Em caso de d√∫vidas, entre em contato conosco respondendo este e-mail.
    </p>
  </div>
</body>
</html>
```

---

## 6. Testes

- [ ] E-mail enviado ap√≥s inscri√ß√£o (verificar fila)
- [ ] QR Code gerado corretamente (base64 v√°lido)
- [ ] Vari√°veis substitu√≠das no template
- [ ] Se conta nova, senha inclu√≠da no e-mail
- [ ] Template HTML renderiza corretamente
- [ ] E-mail recebido em caixa de entrada (n√£o spam)

---

*US EP-03-F3.1-US-BE-04 - Fevereiro/2026*
